{% extends 'main/layout.html' %}

{% block content %}
<main class="relative flex justify-center items-center min-h-[calc(100vh-4rem)] px-4 py-10">
  <!-- Декорный фон -->
  <div aria-hidden="true" class="pointer-events-none absolute inset-x-0 -top-24 -z-10 h-64 bg-gradient-to-b from-primary/10 to-transparent blur-2xl"></div>

  <div class="w-full max-w-2xl">
    <div class="bg-white rounded-2xl ring-1 ring-gray-200 shadow-2xl p-6 md:p-10 animate-[fadeInUp_0.35s_ease-out]">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2 tracking-tight">Создать аккаунт</h1>
        <p class="text-gray-600">Присоединяйтесь к EnglishForYou сегодня</p>
      </div>

      <!-- Non-field errors -->
      {% if form.non_field_errors %}
      <div class="mb-6 rounded-lg border border-red-200 bg-red-50 text-red-700 px-4 py-3 text-sm">
        {{ form.non_field_errors }}
      </div>
      {% endif %}

      <!-- Form -->
      <form id="registrationForm" method="post" class="space-y-6">
        {% csrf_token %}

        <!-- Имя + Фамилия -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label for="{{ form.username.id_for_label }}" class="flex items-center gap-2 font-semibold text-sm text-gray-800 mb-2">
              <i class="fas fa-user text-primary w-4" aria-hidden="true"></i>
              Имя
            </label>
            {{ form.username }}
            {% if form.username.errors %}<p class="mt-2 text-sm text-red-600">{{ form.username.errors.0 }}</p>{% endif %}
            <p class="mt-2 text-sm text-red-600 hidden" data-error-for="username"></p>
          </div>

          <div>
            <label for="{{ form.last_name.id_for_label }}" class="flex items-center gap-2 font-semibold text-sm text-gray-800 mb-2">
              <i class="fas fa-user text-primary w-4" aria-hidden="true"></i>
              Фамилия
            </label>
            {{ form.last_name }}
            {% if form.last_name.errors %}<p class="mt-2 text-sm text-red-600">{{ form.last_name.errors.0 }}</p>{% endif %}
            <p class="mt-2 text-sm text-red-600 hidden" data-error-for="last_name"></p>
          </div>
        </div>

        <!-- Email -->
        <div>
          <label for="{{ form.email.id_for_label }}" class="flex items-center gap-2 font-semibold text-sm text-gray-800 mb-2">
            <i class="fas fa-envelope text-primary w-4" aria-hidden="true"></i>
            Email адрес
          </label>
          {{ form.email }}
          {% if form.email.errors %}<p class="mt-2 text-sm text-red-600">{{ form.email.errors.0 }}</p>{% endif %}
          <p class="mt-2 text-sm text-red-600 hidden" data-error-for="email"></p>
        </div>

        <!-- Пароль + Подтверждение -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div class="flex items-center justify-between mb-2">
              <label for="{{ form.password.id_for_label }}" class="flex items-center gap-2 font-semibold text-sm text-gray-800">
                <i class="fas fa-lock text-primary w-4" aria-hidden="true"></i>
                Пароль
              </label>
              <span class="text-xs text-gray-500">Минимум 8 символов</span>
            </div>
            <div class="relative">
              {{ form.password }}
              <button type="button" id="passwordToggle"
                      class="absolute right-3 top-1/2 -translate-y-1/2 inline-flex items-center justify-center w-9 h-9 text-gray-400 hover:text-primary rounded-md focus-visible:outline-2 focus-visible:outline-primary focus-visible:outline-offset-2"
                      aria-label="Показать пароль" aria-pressed="false">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            {% if form.password.errors %}<p class="mt-2 text-sm text-red-600">{{ form.password.errors.0 }}</p>{% endif %}
            <p class="mt-2 text-sm text-red-600 hidden" data-error-for="password"></p>

            <!-- Индикатор силы пароля -->
            <div id="passwordStrength" class="hidden mt-3">
              <div class="w-full h-1 bg-gray-200 rounded-full overflow-hidden">
                <div id="pwStrengthBar" class="h-full w-0 rounded-full transition-all duration-300"></div>
              </div>
              <span id="pwStrengthText" class="text-xs mt-1 font-medium block text-gray-500">Слабый пароль</span>
            </div>
          </div>

          <div>
            <label for="confirmPassword" class="flex items-center gap-2 font-semibold text-sm text-gray-800 mb-2">
              <i class="fas fa-lock text-primary w-4" aria-hidden="true"></i>
              Подтверждение пароля
            </label>
            <div class="relative">
              <input type="password" id="confirmPassword" name="confirm_password"
                     class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg text-base transition-all focus:outline-none focus:border-primary focus:shadow-[0_0_0_3px_rgba(5,150,105,0.1)] placeholder:text-gray-400"
                     placeholder="Повторите пароль" required>
              <button type="button" id="confirmPasswordToggle"
                      class="absolute right-3 top-1/2 -translate-y-1/2 inline-flex items-center justify-center w-9 h-9 text-gray-400 hover:text-primary rounded-md focus-visible:outline-2 focus-visible:outline-primary focus-visible:outline-offset-2"
                      aria-label="Показать пароль" aria-pressed="false">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <p class="mt-2 text-sm text-red-600 hidden" data-error-for="confirm_password"></p>
          </div>
        </div>

        <!-- Submit -->
        <button type="submit" id="submitBtn"
          class="group relative w-full inline-flex items-center justify-center gap-2 px-6 py-3.5 bg-black text-white rounded-lg font-semibold overflow-hidden transition-all hover:-translate-y-0.5 hover:shadow-md hover:brightness-110 active:brightness-95 disabled:opacity-70 disabled:cursor-not-allowed">
          <span class="absolute inset-0 w-0 bg-primary transition-all duration-300 group-hover:w-full z-0"></span>
          <span class="relative z-10 inline-flex items-center gap-2">
            <i class="fas fa-user-plus" aria-hidden="true"></i>
            <span>Зарегистрироваться</span>
            <i class="fa-solid fa-spinner fa-spin hidden" id="submitSpinner" aria-hidden="true"></i>
          </span>
        </button>
      </form>

      <!-- Footer -->
      <div class="text-center text-gray-600 text-sm mt-6">
        Уже есть аккаунт?
        <a href="{% url 'login' %}" class="text-primary font-semibold hover:underline">Войти</a>
      </div>
    </div>
  </div>
</main>

<script>
  (function () {
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitSpinner = document.getElementById('submitSpinner');

    const usernameInput = form.querySelector('input[name="username"]');
    const lastNameInput = form.querySelector('input[name="last_name"]');
    const emailInput    = form.querySelector('input[name="email"]');
    const pwdInput      = form.querySelector('input[name="password"]');
    const pwd2Input     = document.getElementById('confirmPassword');

    const pwdToggle  = document.getElementById('passwordToggle');
    const pwd2Toggle = document.getElementById('confirmPasswordToggle');

    const strengthWrap = document.getElementById('passwordStrength');
    const strengthBar  = document.getElementById('pwStrengthBar');
    const strengthText = document.getElementById('pwStrengthText');

    function setError(key, message, inputEl) {
      const errorEl = form.querySelector(`[data-error-for="${key}"]`);
      if (errorEl) {
        errorEl.textContent = message || '';
        errorEl.classList.toggle('hidden', !message);
      }
      if (inputEl) {
        inputEl.classList.toggle('border-red-500', Boolean(message));
        inputEl.classList.toggle('bg-red-50/50', Boolean(message));
      }
    }

    function clearFieldError(inputEl) {
      if (!inputEl) return;
      const key = inputEl.name || inputEl.id;
      setError(key, '', inputEl);
    }

    function emailValid(value) {
      return /\S+@\S+\.\S+/.test(value);
    }

    function updateStrength(value) {
      if (!strengthWrap || !strengthBar || !strengthText) return;
      if (!value) {
        strengthWrap.classList.add('hidden');
        return;
      }
      strengthWrap.classList.remove('hidden');

      let s = 0;
      if (value.length >= 8) s++;
      if (/[a-z]/.test(value)) s++;
      if (/[A-Z]/.test(value)) s++;
      if (/[0-9]/.test(value)) s++;
      if (/[^A-Za-z0-9]/.test(value)) s++;

      const pct = (s / 5) * 100;
      strengthBar.style.width = pct + '%';

      let label = 'Очень слабый', color = '#ef4444';
      if (s === 2) { label = 'Слабый'; color = '#f59e0b'; }
      if (s === 3) { label = 'Средний'; color = '#eab308'; }
      if (s === 4) { label = 'Сильный'; color = '#22c55e'; }
      if (s === 5) { label = 'Очень сильный'; color = '#059669'; }

      strengthBar.style.backgroundColor = color;
      strengthText.textContent = label;
      strengthText.style.color = color;
    }

    function setupToggle(btn, input) {
      if (!btn || !input) return;
      btn.addEventListener('click', () => {
        const isHidden = input.type === 'password';
        input.type = isHidden ? 'text' : 'password';
        btn.setAttribute('aria-pressed', String(isHidden));
        const icon = btn.querySelector('i');
        if (icon) {
          icon.classList.toggle('fa-eye', !isHidden);
          icon.classList.toggle('fa-eye-slash', isHidden);
        }
      });
    }

    setupToggle(pwdToggle, pwdInput);
    setupToggle(pwd2Toggle, pwd2Input);

    pwdInput?.addEventListener('input', (e) => updateStrength(e.target.value));

    function validateForm() {
      let ok = true;

      if (usernameInput && !usernameInput.value.trim()) {
        setError('username', 'Введите ваше имя', usernameInput); ok = false;
      }
      if (lastNameInput && !lastNameInput.value.trim()) {
        setError('last_name', 'Введите вашу фамилию', lastNameInput); ok = false;
      }
      if (emailInput && !emailInput.value.trim()) {
        setError('email', 'Введите email адрес', emailInput); ok = false;
      } else if (emailInput && !emailValid(emailInput.value.trim())) {
        setError('email', 'Введите корректный email адрес', emailInput); ok = false;
      }
      if (pwdInput && !pwdInput.value) {
        setError('password', 'Создайте пароль', pwdInput); ok = false;
      } else if (pwdInput && pwdInput.value.length < 8) {
        setError('password', 'Пароль должен содержать минимум 8 символов', pwdInput); ok = false;
      }
      if (pwd2Input) {
        if (!pwd2Input.value) {
          setError('confirm_password', 'Подтвердите пароль', pwd2Input); ok = false;
        } else if (pwdInput && pwdInput.value !== pwd2Input.value) {
          setError('confirm_password', 'Пароли не совпадают', pwd2Input); ok = false;
        }
      }

      return ok;
    }

    form.addEventListener('submit', (e) => {
      if (!validateForm()) {
        e.preventDefault();
        return;
      }
      submitBtn.disabled = true;
      submitSpinner?.classList.remove('hidden');
    });

    [usernameInput, lastNameInput, emailInput, pwdInput, pwd2Input]
      .filter(Boolean)
      .forEach((el) => el.addEventListener('input', () => clearFieldError(el)));

    // Автофокус
    window.addEventListener('DOMContentLoaded', () => usernameInput?.focus());
  })();
</script>

<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }
</style>
{% endblock %}